!gcloud auth application-default login
# Get key

!gcloud config set project PROJECT-NAME
# Assign key

# Initialize R
%load_ext rpy2.ipython
%R devtools::install_github("hadley/lazyeval", build_vignettes = TRUE)



def sql_pull(script) -> str:
  import pandas as pd
  import pandas_gbq as pg
  from google.cloud import bigquery
  # Get Big Query
  project = 'PROJECT-NAME'
  client = bigquery.Client(project=project)

  # R
  import rpy2 as R
  import rpy2.robjects.lib.ggplot2 as gp
  from rpy2.robjects import rl
  from rpy2.robjects.packages import importr
  utils = importr('utils')

  try:
    # Preform a query
    SQL = script
    query_job = client.query(SQL) # API request
    rows = query_job.result()

    if query_job.state == 'DONE': # DataFrame
      dframe = query_job.to_dataframe()
      dframe.to_csv('test.csv', index=False) # Prepare .csv
      dfile = utils.read_csv('/content/test.csv') 
    else:
      print(query_job.result())

  except:
    print('Bad input')
    
    

# Visualization
def visual(csv_path):
  import rpy2 as R
  from rpy2.robjects.packages import importr
  import rpy2.robjects.lib.ggplot2 as gp
  from rpy2.robjects import rl

  utils = importr('utils')
  dfile = utils.read_csv(csv_path)

  # Create graph
  graph = (gp.ggplot(dfile) +
      gp.aes(x=rl(' '),
              y=rl(' '),
              color=rl(' '),
              size=rl(' ')) +
      gp.geom_point() +
      gp.scale_color_continuous(trans='log10'))
  
  # Produce image
  from rpy2.ipython.ggplot import image_png
  vis = image_png(graph)
  return vis
  
sql_pull("""INSERT SQL SCRIPT""")
%R fileoutput <- read.csv('FILE-NAME.csv')
%R print(fileoutput)
visual('FILE-PATH')
